<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Регистрация правовых актов</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      max-width: 700px;
      margin: 30px auto;
      font-family: Arial, sans-serif;
    }
    input, button, select, textarea {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .doc {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Добро пожаловать в регистрацию правовых актов</h1>

  <div id="formSection">
    <input type="text" id="discordNick" placeholder="Ник в Discord" />
    <input type="text" id="fio" placeholder="ФИО (3 слова)" />
    <select id="department">
      <option value="Министерство внутренних дел">Министерство внутренних дел</option>
      <option value="ФСБ">ФСБ</option>
      <option value="Правительство">Правительство</option>
      <option value="Своя фракция">Своя фракция</option>
    </select>
    <input type="text" id="customDept" placeholder="Если своя фракция, укажите здесь" />
    <select id="docType">
      <option value="Указ">Указ</option>
      <option value="Постановление">Постановление</option>
      <option value="Приказ">Приказ</option>
    </select>
    <input type="text" id="docNumber" placeholder="Номер документа" />
    <input type="text" id="title" placeholder="Название документа" />
    <textarea id="description" placeholder="Описание (необязательно)"></textarea>
    <input type="date" id="pubDate" />
    <input type="file" id="fileInput" />
    <button id="submitBtn">Отправить документ</button>
  </div>

  <div id="docs"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJX1aiBnBg_dVQ_AOA5L3rsvQyLgIb27E",
      authDomain: "legal-acts-portal.firebaseapp.com",
      projectId: "legal-acts-portal",
      storageBucket: "legal-acts-portal.appspot.com",
      messagingSenderId: "969951897920",
      appId: "1:969951897920:web:3e35b87565cfcc9e0832a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const discordNick = document.getElementById('discordNick');
    const fio = document.getElementById('fio');
    const department = document.getElementById('department');
    const customDept = document.getElementById('customDept');
    const docType = document.getElementById('docType');
    const docNumber = document.getElementById('docNumber');
    const title = document.getElementById('title');
    const description = document.getElementById('description');
    const pubDate = document.getElementById('pubDate');
    const fileInput = document.getElementById('fileInput');
    const submitBtn = document.getElementById('submitBtn');
    const docsDiv = document.getElementById('docs');

    submitBtn.onclick = async () => {
      const fioVal = fio.value.trim();
      if (fioVal.split(' ').length !== 3) {
        alert('ФИО должно содержать 3 слова');
        return;
      }
      if (!fileInput.files.length) {
        alert('Выберите файл');
        return;
      }
      const dept = department.value === 'Своя фракция' ? customDept.value.trim() : department.value;
      if (!dept) {
        alert('Укажите фракцию');
        return;
      }

      const file = fileInput.files[0];
      const filePath = `documents/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, filePath);

      try {
        await uploadBytes(storageRef, file);
        const fileURL = await getDownloadURL(storageRef);

        const docRef = await addDoc(collection(db, 'documents'), {
          discordNick: discordNick.value.trim(),
          fio: fioVal,
          department: dept,
          docType: docType.value,
          docNumber: docNumber.value.trim(),
          title: title.value.trim(),
          description: description.value.trim(),
          pubDate: pubDate.value,
          fileName: file.name,
          fileURL,
          createdAt: new Date()
        });

        alert('Документ успешно отправлен!');
        loadDocuments();

        // Очистим форму
        discordNick.value = '';
        fio.value = '';
        department.value = 'Министерство внутренних дел';
        customDept.value = '';
        docType.value = 'Указ';
        docNumber.value = '';
        title.value = '';
        description.value = '';
        pubDate.value = '';
        fileInput.value = '';

      } catch (e) {
        alert('Ошибка загрузки: ' + e.message);
      }
    };

    async function loadDocuments() {
      docsDiv.innerHTML = '<h2>Документы</h2>';
      const q = query(collection(db, 'documents'));
      const snapshot = await getDocs(q);

      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        const div = document.createElement('div');
        div.className = 'doc';
        div.innerHTML = `
          <strong>${d.title || d.docType}</strong><br>
          ФИО: ${d.fio}<br>
          Фракция: ${d.department}<br>
          Номер: ${d.docNumber}<br>
          Описание: ${d.description || '—'}<br>
          Дата публикации: ${d.pubDate || '—'}<br>
          <a href="${d.fileURL}" target="_blank" rel="noopener noreferrer">Открыть файл</a><br>
          <div id="qrcode-${docSnap.id}"></div>
        `;
        docsDiv.appendChild(div);

        const qrInfo = `ФИО: ${d.fio} | Фракция: ${d.department} | Документ: ${d.title} | Номер: ${d.docNumber} | Ссылка: ${d.fileURL}`;
        new QRCode(document.getElementById(`qrcode-${docSnap.id}`), {
          text: qrInfo,
          width: 100,
          height: 100,
          colorDark : "#000000",
          colorLight : "#ffffff",
        });
      });
    }

    loadDocuments();
  </script>
</body>
</html>
