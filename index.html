<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Регистрация правовых актов</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { max-width: 700px; margin: 30px auto; font-family: Arial, sans-serif; }
    input, select, textarea, button { padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box; }
    .doc { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; position: relative; }
    .qr-code { position: absolute; right: 10px; top: 10px; }
  </style>
</head>
<body>

<h1>Добро пожаловать в регистрацию правовых актов</h1>

<div>
  <input id="discordNick" placeholder="Ник в Discord*" />
  <input id="fio" placeholder="ФИО (3 слова)*" />
  <select id="department">
    <option value="" disabled selected>Выберите отдел</option>
    <option value="Министерство обороны">Министерство обороны</option>
    <option value="Министерство финансов">Министерство финансов</option>
    <option value="ФСБ">ФСБ</option>
    <option value="Другое">Свой вариант</option>
  </select>
  <input id="customDept" placeholder="Если своё — укажите отдел" />
  <select id="docType">
    <option value="" disabled selected>Тип документа*</option>
    <option value="Указ">Указ</option>
    <option value="Постановление">Постановление</option>
    <option value="Приказ">Приказ</option>
    <option value="Распоряжение">Распоряжение</option>
  </select>
  <input id="docNumber" placeholder="Номер документа*" />
  <input id="title" placeholder="Название документа*" />
  <textarea id="description" placeholder="Описание (необязательно)"></textarea>
  <input id="pubDate" type="date" />
  <input id="fileInput" type="file" />
  <button id="submitBtn">Отправить документ</button>
</div>

<hr/>

<div id="docs"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

  const firebaseConfig = { /* твоя конфигурация Firebase */ };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const discordNick = document.getElementById('discordNick');
  const fio = document.getElementById('fio');
  const department = document.getElementById('department');
  const customDept = document.getElementById('customDept');
  const docType = document.getElementById('docType');
  const docNumber = document.getElementById('docNumber');
  const title = document.getElementById('title');
  const description = document.getElementById('description');
  const pubDate = document.getElementById('pubDate');
  const fileInput = document.getElementById('fileInput');
  const submitBtn = document.getElementById('submitBtn');
  const docsDiv = document.getElementById('docs');

  submitBtn.onclick = async () => {
    // Проверки
    if (!discordNick.value.trim() || fio.value.trim().split(' ').length !== 3 ||
        !department.value || !docType.value || !docNumber.value.trim() ||
        !title.value.trim() || !fileInput.files.length) {
      return alert('Пожалуйста, заполните все обязательные поля корректно.');
    }
    let dept = department.value;
    if (dept === 'Другое') {
      dept = customDept.value.trim();
      if (!dept) return alert('Укажите свой отдел.');
    }

    const file = fileInput.files[0];
    const storageRef = ref(storage, `documents/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const fileURL = await getDownloadURL(storageRef);

    await addDoc(collection(db, 'documents'), {
      discordNick: discordNick.value.trim(),
      fio: fio.value.trim(),
      department: dept,
      docType: docType.value,
      docNumber: docNumber.value.trim(),
      title: title.value.trim(),
      description: description.value.trim(),
      pubDate: pubDate.value,
      fileName: file.name,
      fileURL,
      createdAt: new Date()
    });

    alert('Документ отправлен!');
    clearForm();
    loadDocuments();
  };

  function clearForm() {
    discordNick.value = fio.value = docNumber.value = title.value = description.value = customDept.value = '';
    department.value = docType.value = pubDate.value = '';
    fileInput.value = '';
  }

  async function loadDocuments() {
    docsDiv.innerHTML = '';
    const snapshot = await getDocs(query(collection(db, 'documents'), orderBy('createdAt', 'desc')));
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const div = document.createElement('div');
      div.className = 'doc';
      div.innerHTML = `
        <strong>${d.docType} №${d.docNumber} — ${d.title}</strong><br>
        Discord: ${d.discordNick}<br>
        ФИО: ${d.fio}<br>
        Отдел: ${d.department}<br>
        Описание: ${d.description || '—'}<br>
        Дата публикации: ${d.pubDate || '—'}<br>
        <a href="${d.fileURL}" target="_blank">Открыть файл (${d.fileName})</a>
        <div id="qr-${docSnap.id}" class="qr-code"></div>
      `;
      docsDiv.appendChild(div);
      const info = `ФИО: ${d.fio}\nОтдел: ${d.department}\nДокумент: ${d.title}\nНомер: ${d.docNumber}\nURL: ${d.fileURL}`;
      new QRCode(document.getElementById(`qr-${docSnap.id}`), { text: info, width: 100, height: 100 });
    });
  }

  loadDocuments();
</script>
</body>
</html>
