<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Legal Acts Portal</title>
<style>
  body { max-width: 600px; margin: 20px auto; font-family: Arial, sans-serif; }
  input, select, button, textarea { width: 100%; padding: 8px; margin: 5px 0; }
  .hidden { display: none; }
  .doc { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  .admin-buttons button { margin-right: 5px; }
  #logs { max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>Legal Acts Portal</h1>

<div id="loginSection">
  <h2>Вход</h2>
  <input type="text" id="loginInput" placeholder="Логин" />
  <input type="password" id="passwordInput" placeholder="Пароль" />
  <button id="loginBtn">Войти</button>
</div>

<div id="welcomeSection" class="hidden">
  <p id="welcomeText"></p>
  <button id="logoutBtn">Выйти</button>
</div>

<div id="createDocSection" class="hidden">
  <h2>Регистрация акта</h2>
  <input type="text" id="fioInput" placeholder="ФИО (3 слова)" />
  <input type="text" id="departmentInput" placeholder="Отдел" />
  <select id="docTypeSelect">
    <option value="Указ">Указ</option>
    <option value="Постановление">Постановление</option>
  </select>
  <input type="text" id="docNameInput" placeholder="Название документа" />
  <textarea id="docDescInput" placeholder="Описание (необязательно)"></textarea>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Загрузить документ</button>
  <p id="uploadStatus"></p>
</div>

<div id="docsSection" class="hidden">
  <h2>Документы</h2>
  <div id="docsList"></div>
</div>

<div id="logsSection" class="hidden">
  <h2>Логи</h2>
  <div id="logs"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBJX1aiBnBg_dVQ_AOA5L3rsvQyLgIb27E",
    authDomain: "legal-acts-portal.firebaseapp.com",
    projectId: "legal-acts-portal",
    storageBucket: "legal-acts-portal.appspot.com",
    messagingSenderId: "969951897920",
    appId: "1:969951897920:web:3e35b87565cfcc9e0832a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Жестко заданные аккаунты с ролями и именами
  const ACCOUNTS = {
    "kirill12633": { password: "12345", role: "creator", name: "Kirill" },
    "minjust": { password: "5864", role: "minjust", name: "Министерство Юстиции" },
    "president": { password: "5648", role: "president", name: "Президент РФ" }
  };

  let currentUser = null;

  // Элементы DOM
  const loginSection = document.getElementById('loginSection');
  const welcomeSection = document.getElementById('welcomeSection');
  const welcomeText = document.getElementById('welcomeText');
  const logoutBtn = document.getElementById('logoutBtn');

  const createDocSection = document.getElementById('createDocSection');
  const fioInput = document.getElementById('fioInput');
  const departmentInput = document.getElementById('departmentInput');
  const docTypeSelect = document.getElementById('docTypeSelect');
  const docNameInput = document.getElementById('docNameInput');
  const docDescInput = document.getElementById('docDescInput');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadStatus = document.getElementById('uploadStatus');

  const docsSection = document.getElementById('docsSection');
  const docsList = document.getElementById('docsList');

  const logsSection = document.getElementById('logsSection');
  const logsDiv = document.getElementById('logs');

  // Логирование действий
  async function logAction(action, docId = null) {
    const logEntry = {
      user: currentUser.name,
      role: currentUser.role,
      action,
      docId,
      timestamp: new Date()
    };
    await addDoc(collection(db, 'logs'), logEntry);
    if (currentUser.role === 'president') loadLogs();
  }

  // Вход
  document.getElementById('loginBtn').onclick = () => {
    const login = document.getElementById('loginInput').value.trim();
    const password = document.getElementById('passwordInput').value.trim();

    if (!(login in ACCOUNTS)) {
      alert('Неверный логин');
      return;
    }
    if (ACCOUNTS[login].password !== password) {
      alert('Неверный пароль');
      return;
    }
    currentUser = { login, ...ACCOUNTS[login] };
    onUserLoggedIn();
  };

  // Выход
  logoutBtn.onclick = () => {
    currentUser = null;
    onUserLoggedOut();
  };

  function onUserLoggedIn() {
    loginSection.classList.add('hidden');
    welcomeSection.classList.remove('hidden');
    docsSection.classList.remove('hidden');
    welcomeText.textContent = `Добро пожаловать, вы вошли как ${currentUser.name} (${currentUser.role})`;

    // Показать секцию создания документа только создателю
    createDocSection.classList.toggle('hidden', currentUser.role !== 'creator');

    // Логи доступны только президенту
    logsSection.classList.toggle('hidden', currentUser.role !== 'president');

    loadDocuments();
    if (currentUser.role === 'president') loadLogs();
  }

  function onUserLoggedOut() {
    loginSection.classList.remove('hidden');
    welcomeSection.classList.add('hidden');
    createDocSection.classList.add('hidden');
    docsSection.classList.add('hidden');
    logsSection.classList.add('hidden');
    docsList.innerHTML = '';
    logsDiv.innerHTML = '';
    // Очистка полей
    fioInput.value = '';
    departmentInput.value = '';
    docNameInput.value = '';
    docDescInput.value = '';
    fileInput.value = '';
  }

  // Загрузка документа
  uploadBtn.onclick = async () => {
    const fio = fioInput.value.trim();
    if (fio.split(' ').length !== 3) {
      alert('ФИО должно содержать 3 слова');
      return;
    }
    if (!departmentInput.value.trim()) {
      alert('Введите отдел');
      return;
    }
    if (!docNameInput.value.trim()) {
      alert('Введите название документа');
      return;
    }
    if (!fileInput.files.length) {
      alert('Выберите файл');
      return;
    }

    const file = fileInput.files[0];
    const docType = docTypeSelect.value;

    uploadStatus.textContent = 'Загрузка...';

    try {
      const storageRef = ref(storage, `documents/${Date.now()}_${file.name}`);
      await uploadBytes(storageRef, file);
      const fileURL = await getDownloadURL(storageRef);

      // Создаем уникальный код документа, например дата + рандом 4 цифры
      const docNumber = `№${Date.now().toString().slice(-5)}-${Math.floor(Math.random() * 9000 + 1000)}`;

      // Сохраняем в Firestore
      await addDoc(collection(db, 'documents'), {
        fio,
        department: departmentInput.value.trim(),
        docType,
        docName: docNameInput.value.trim(),
        docDesc: docDescInput.value.trim(),
        fileName: file.name,
        fileURL,
        docNumber,
        status: "Ждет одобрения",
        createdBy: currentUser.login,
        createdByName: currentUser.name,
        createdAt: new Date()
      });

      await logAction(`Создан документ ${docNameInput.value.trim()} (${docNumber})`);

      uploadStatus.textContent = 'Документ успешно загружен!';
      fioInput.value = '';
      departmentInput.value = '';
      docNameInput.value = '';
      docDescInput.value = '';
      fileInput.value = '';

      loadDocuments();

    } catch (e) {
      uploadStatus.textContent = 'Ошибка загрузки: ' + e.message;
    }
  };

  // Загрузка и отображение документов
  async function loadDocuments() {
    docsList.innerHTML = '';

    const q = query(collection(db, 'documents'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);

    snapshot.forEach(docSnap => {
      const docData = docSnap.data();
      const div = document.createElement('div');
      div.className = 'doc';

      div.innerHTML = `
        <b>${docData.docType} - ${docData.docName}</b> ${docData.docNumber} <br/>
        ФИО: ${docData.fio} <br/>
        Отдел: ${docData.department} <br/>
        Статус: ${docData.status} <br/>
        Создано: ${docData.createdByName} <br/>
        <a href="${docData.fileURL}" target="_blank">Открыть документ</a>
      `;

      // Кнопки для минюста и президента
      if (["minjust", "president"].includes(currentUser.role)) {
        const adminButtons = document.createElement('div');
        adminButtons.className = 'admin-buttons';

        // Одобрить
        const approveBtn = document.createElement('button');
        approveBtn.textContent = 'Одобрить';
        approveBtn.onclick = async () => {
          await updateStatus(docSnap.id, 'Одобрен');
          await logAction(`Одобрил документ ${docData.docName} (${docData.docNumber})`, docSnap.id);
        };

        // Отклонить
        const rejectBtn = document.createElement('button');
        rejectBtn.textContent = 'Отклонить';
        rejectBtn.onclick = async () => {
          await updateStatus(docSnap.id, 'Отклонен');
          await logAction(`Отклонил документ ${docData.docName} (${docData.docNumber})`, docSnap.id);
        };

        adminButtons.appendChild(approveBtn);
        adminButtons.appendChild(rejectBtn);

        // Удалять может только президент
        if (currentUser.role === 'president') {
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Удалить';
          deleteBtn.onclick = async () => {
            if (confirm('Удалить документ?')) {
              await deleteDoc(doc(db, 'documents', docSnap.id));
              await logAction(`Удалил документ ${docData.docName} (${docData.docNumber})`, docSnap.id);
              loadDocuments();
            }
          };
          adminButtons.appendChild(deleteBtn);
        }

        div.appendChild(adminButtons);
      }

      docsList.appendChild(div);
    });
  }

  async function updateStatus(docId, newStatus) {
    const docRef = doc(db, 'documents', docId);
    await updateDoc(docRef, { status: newStatus });
    loadDocuments();
  }

  // Загрузка логов (для президента)
  async function loadLogs() {
    logsDiv.innerHTML = '';
    const q = query(collection(db, 'logs'), orderBy('timestamp', 'desc'));
    const snapshot = await getDocs(q);

    snapshot.forEach(docSnap => {
      const log = docSnap.data();
      const timeStr = new Date(log.timestamp.seconds * 1000).toLocaleString();
      const div = document.createElement('div');
      div.textContent = `[${timeStr}] ${log.user} (${log.role}): ${log.action}`;
      logsDiv.appendChild(div);
    });
  }

</script>

</body>
</html>
